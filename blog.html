<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog - logits</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-brand">
        <img src="images/logx.PNG" alt="logits">
        <span>logits</span>
      </a>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="blog.html" class="active">Blog</a></li>
      </ul>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">
        <span class="sun-icon">‚òÄÔ∏è</span>
        <span class="moon-icon">üåô</span>
      </button>
    </div>
  </nav>

  <main class="container">
    <section class="blog-section">
      <div class="blog-header">
        <h1>Blog</h1>
        <a href="blog-converter.html" class="add-blog-btn" title="Create new blog post">+ Add Blog</a>
      </div>
      <p class="section-description">Thoughts on Machine Learning, Deep Learning, and AI</p>

      <!-- Category Filter - populated dynamically -->
      <div class="blog-categories" id="categoryFilters">
        <button class="category-btn active" data-category="all">All Posts</button>
      </div>

      <!-- Blog Grid - populated dynamically -->
      <div class="blog-grid" id="blogGrid">
        <p class="loading-message">Loading posts...</p>
      </div>

    </section>
  </main>

  <script src="script.js"></script>
  <style>
    .blog-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
    }

    .edit-btn {
      padding: 0.4rem 0.75rem;
      font-size: 13px;
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .edit-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .blog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .blog-header h1 {
      margin: 0;
    }

    .add-blog-btn {
      padding: 0.5rem 1rem;
      font-size: 14px;
      font-weight: 500;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      transition: var(--transition);
    }

    .add-blog-btn:hover {
      background: var(--accent-hover, #0056b3);
      transform: translateY(-1px);
    }

    .loading-message {
      color: var(--text-tertiary);
      font-style: italic;
      grid-column: 1 / -1;
    }
  </style>
  <script>
    // Global posts data
    let postsData = null;

    // Load posts from JSON
    async function loadPosts() {
      try {
        const response = await fetch('posts.json');
        if (!response.ok) throw new Error('Could not load posts.json');
        postsData = await response.json();
        
        renderCategories();
        renderPosts();
        setupEventListeners();
        hideProductionElements();
      } catch (error) {
        console.error('Error loading posts:', error);
        document.getElementById('blogGrid').innerHTML = 
          '<p class="loading-message">Error loading posts. Make sure posts.json exists.</p>';
      }
    }

    // Render category filter buttons
    function renderCategories() {
      const container = document.getElementById('categoryFilters');
      let html = '<button class="category-btn active" data-category="all">All Posts</button>';
      
      for (const [key, name] of Object.entries(postsData.categories)) {
        html += `<button class="category-btn" data-category="${key}">${name}</button>`;
      }
      
      container.innerHTML = html;
    }

    // Render blog posts
    function renderPosts() {
      const container = document.getElementById('blogGrid');
      const isProduction = window.location.hostname.includes('github.io');
      
      // Sort posts by date (newest first)
      const sortedPosts = [...postsData.posts].sort((a, b) => {
        return new Date(b.date) - new Date(a.date);
      });

      let html = '';
      
      sortedPosts.forEach(post => {
        // Look up display names from mappings
        const categoryName = postsData.categories[post.category] || post.category;
        const seriesName = post.series ? postsData.series[post.series] : null;
        
        const seriesAttr = post.series ? ` data-series="${post.series}"` : '';
        const seriesHtml = seriesName 
          ? `<div class="blog-series">Part of: <a href="#" class="series-link" data-series="${post.series}">${seriesName}</a></div>`
          : '';
        
        const editButton = isProduction ? '' : 
          `<button class="edit-btn" onclick="editPost('${post.source}')" title="Edit this post">‚úèÔ∏è Edit</button>`;

        html += `
        <article class="blog-card" data-category="${post.category}"${seriesAttr} data-source="${post.source}" data-id="${post.id}">
          <div class="blog-meta">
            <span class="blog-date">${post.date}</span>
            <span class="blog-tag">${categoryName}</span>
          </div>
          <h2><a href="posts/${post.id}.html">${post.title}</a></h2>
          <p class="blog-excerpt">${post.excerpt}</p>
          ${seriesHtml}
          <div class="blog-actions">
            <a href="posts/${post.id}.html" class="read-more">Read More ‚Üí</a>
            ${editButton}
          </div>
        </article>`;
      });
      
      container.innerHTML = html || '<p class="loading-message">No posts yet.</p>';
    }

    // Setup event listeners for filtering
    function setupEventListeners() {
      // Category filtering
      document.querySelectorAll('.category-btn').forEach(button => {
        button.addEventListener('click', () => {
          const category = button.getAttribute('data-category');

          // Update active button
          document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');

          // Filter blog posts
          document.querySelectorAll('.blog-card').forEach(card => {
            if (category === 'all' || card.getAttribute('data-category') === category) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        });
      });

      // Series filtering
      document.querySelectorAll('.series-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          filterBySeries(link.getAttribute('data-series'));
        });
      });
    }

    // Filter by series
    function filterBySeries(seriesId) {
      // Clear category button active states
      document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));

      // Filter to show only posts in this series
      document.querySelectorAll('.blog-card').forEach(card => {
        if (card.getAttribute('data-series') === seriesId) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });

      // Scroll to top of blog grid
      document.getElementById('blogGrid').scrollIntoView({ behavior: 'smooth' });
    }

    // Hide elements in production
    function hideProductionElements() {
      if (window.location.hostname.includes('github.io')) {
        document.querySelectorAll('.add-blog-btn').forEach(btn => btn.style.display = 'none');
      }
    }

    // Edit post - opens blog-converter with the post content and metadata
    async function editPost(filename) {
      const isLocalFile = window.location.protocol === 'file:';

      // Find post metadata from JSON
      const post = postsData.posts.find(p => p.source === filename);

      if (isLocalFile) {
        // Store metadata even for file:// protocol
        if (post) {
          sessionStorage.setItem('editPostMetadata', JSON.stringify(post));
        }
        alert('Opening blog converter. Use "Load Draft" button and select:\n\npostdocs/' + filename);
        window.location.href = 'blog-converter.html?edit=' + encodeURIComponent(filename);
        return;
      }

      try {
        // Fetch the markdown source from postdocs folder
        const response = await fetch('postdocs/' + filename);
        if (!response.ok) {
          throw new Error('Could not load post source');
        }
        const content = await response.text();

        // Store content and metadata in sessionStorage
        sessionStorage.setItem('editPostContent', content);
        sessionStorage.setItem('editPostFilename', filename);
        if (post) {
          sessionStorage.setItem('editPostMetadata', JSON.stringify(post));
        }
        
        window.location.href = 'blog-converter.html?edit=' + encodeURIComponent(filename);
      } catch (error) {
        // Store metadata even on error
        if (post) {
          sessionStorage.setItem('editPostMetadata', JSON.stringify(post));
        }
        alert('Could not auto-load content. Opening converter - use "Load Draft" to open:\n\npostdocs/' + filename);
        window.location.href = 'blog-converter.html?edit=' + encodeURIComponent(filename);
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', loadPosts);
  </script>
</body>

</html>